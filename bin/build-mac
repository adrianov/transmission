#!/usr/bin/env bash
set -euo pipefail

root_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
build_dir="${root_dir}/build"
app_path="${build_dir}/macosx/Transmission.app"

if cmake -B "${build_dir}" -G Ninja -DCMAKE_BUILD_TYPE=Release 2>&1 | grep -q "generator.*does not match"; then
    rm -rf "${build_dir}"
    cmake -B "${build_dir}" -G Ninja -DCMAKE_BUILD_TYPE=Release
fi
cmake --build "${build_dir}" -t transmission-mac

if [[ -d "${app_path}" ]]; then
    open -R "${app_path}"
else
    open "${build_dir}/macosx"
fi
